import express from "express";
import axios from "axios";
import dotenv from "dotenv";
import cors from "cors";

dotenv.config();
const app = express();
app.use(cors());
app.use(express.json());

// Career guidance responses database
const careerResponses = {
  // After 10th grade guidance
  after10th: {
    keywords: ["10th", "tenth", "after 10th", "stream selection", "science commerce arts"],
    response: `Great question! After 10th grade, you have three main streams to choose from:

üéØ **Science Stream:**
‚Ä¢ **PCM (Physics, Chemistry, Mathematics)** - Best for engineering, architecture, defense services
‚Ä¢ **PCB (Physics, Chemistry, Biology)** - Ideal for medical, pharmacy, biotechnology, agriculture
‚Ä¢ **PCMB** - If you're unsure, gives flexibility for both medical and engineering

üî¨ **Commerce Stream:**
‚Ä¢ Perfect for business, finance, accounting, economics
‚Ä¢ Leads to CA, CS, CFA, MBA, BBA courses
‚Ä¢ Good for entrepreneurship and business management

üé® **Arts/Humanities Stream:**
‚Ä¢ Excellent for psychology, sociology, literature, history
‚Ä¢ Great foundation for law, journalism, mass communication
‚Ä¢ Good for civil services, teaching, social work

üí° **My Recommendation:**
1. **Assess your interests** - What subjects do you enjoy most?
2. **Consider your strengths** - Where do you perform better?
3. **Think about your career goals** - What profession interests you?
4. **Research career prospects** - What are the job opportunities?

Would you like me to help you assess your interests or explore specific career paths in any of these streams?`
  },

  // Engineering guidance
  engineering: {
    keywords: ["engineering", "engineer", "computer science", "mechanical", "civil", "electronics"],
    response: `Engineering is an excellent career choice! Here's a comprehensive guide:

üöÄ **Popular Engineering Branches:**

**Computer Science & IT:**
‚Ä¢ Software Development, AI/ML, Cybersecurity
‚Ä¢ High demand, excellent salary prospects
‚Ä¢ Companies: Google, Microsoft, Amazon, startups

**Mechanical Engineering:**
‚Ä¢ Automotive, aerospace, manufacturing
‚Ä¢ Core engineering with broad applications
‚Ä¢ Companies: Tesla, BMW, Boeing, ISRO

**Civil Engineering:**
‚Ä¢ Infrastructure, construction, urban planning
‚Ä¢ Government and private sector opportunities
‚Ä¢ Companies: L&T, TATA, government projects

**Electronics & Communication:**
‚Ä¢ Telecommunications, IoT, embedded systems
‚Ä¢ Growing field with 5G and smart technologies
‚Ä¢ Companies: Qualcomm, Intel, Samsung

**Biotechnology:**
‚Ä¢ Pharmaceuticals, research, healthcare
‚Ä¢ Emerging field with great potential
‚Ä¢ Companies: Biocon, Dr. Reddy's, research institutes

üíº **Career Paths:**
‚Ä¢ **Corporate Sector** - MNCs, startups, product companies
‚Ä¢ **Government** - PSUs, defense, research organizations
‚Ä¢ **Entrepreneurship** - Start your own tech company
‚Ä¢ **Higher Studies** - MS, MBA, PhD

üéØ **My Advice:**
1. Choose based on your interests, not just salary
2. Focus on practical skills and projects
3. Build a strong portfolio
4. Stay updated with latest technologies

Which engineering branch interests you most? I can provide more specific guidance!`
  },

  // Medical guidance
  medical: {
    keywords: ["medical", "doctor", "mbbs", "medical field", "healthcare", "neet"],
    response: `The medical field offers incredibly rewarding career opportunities! Here's your guide:

üè• **Medical Career Paths:**

**MBBS (Bachelor of Medicine & Surgery):**
‚Ä¢ 5.5 years course including 1 year internship
‚Ä¢ Entry through NEET exam
‚Ä¢ Leads to specialization (MD/MS) or super-specialization (DM/MCh)

**Alternative Medical Courses:**
‚Ä¢ **BDS** - Dentistry (4 years)
‚Ä¢ **BAMS** - Ayurvedic Medicine (5.5 years)
‚Ä¢ **BHMS** - Homeopathic Medicine (5.5 years)
‚Ä¢ **BVSc** - Veterinary Science (5 years)
‚Ä¢ **B.Pharm** - Pharmacy (4 years)
‚Ä¢ **BPT** - Physiotherapy (4.5 years)

**Paramedical Courses:**
‚Ä¢ **Nursing** - B.Sc Nursing (4 years)
‚Ä¢ **Medical Lab Technology** - BMLT (3 years)
‚Ä¢ **Radiology & Imaging** - B.Sc Radiology (3 years)
‚Ä¢ **Optometry** - B.Optom (4 years)

üí° **Career Opportunities:**
‚Ä¢ **Clinical Practice** - Private practice, hospitals
‚Ä¢ **Government Sector** - Government hospitals, health centers
‚Ä¢ **Research** - Medical research, clinical trials
‚Ä¢ **Academics** - Teaching in medical colleges
‚Ä¢ **Public Health** - WHO, UNICEF, health organizations

üéØ **My Recommendation:**
1. **Passion is key** - Medicine requires dedication and empathy
2. **Long-term commitment** - It's a lifelong learning journey
3. **Financial investment** - Consider the cost of education
4. **Work-life balance** - Medical profession can be demanding

Are you considering MBBS or interested in other medical fields? I can provide more specific guidance!`
  },

  // Commerce and Business
  commerce: {
    keywords: ["commerce", "business", "ca", "cs", "cfa", "mba", "finance", "accounting"],
    response: `Commerce offers diverse and lucrative career opportunities! Here's your comprehensive guide:

üí∞ **Professional Courses:**

**Chartered Accountancy (CA):**
‚Ä¢ 3-year articleship + exams
‚Ä¢ High demand in all sectors
‚Ä¢ Average salary: ‚Çπ6-15 LPA (varies by experience)

**Company Secretary (CS):**
‚Ä¢ Corporate law and compliance
‚Ä¢ Growing demand in corporate sector
‚Ä¢ Average salary: ‚Çπ4-12 LPA

**Chartered Financial Analyst (CFA):**
‚Ä¢ Investment and portfolio management
‚Ä¢ International recognition
‚Ä¢ Average salary: ‚Çπ8-20 LPA

**Cost & Management Accountant (CMA):**
‚Ä¢ Cost control and management accounting
‚Ä¢ Good for manufacturing and service sectors
‚Ä¢ Average salary: ‚Çπ5-12 LPA

üéì **Degree Courses:**
‚Ä¢ **BBA** - Business Administration (3 years)
‚Ä¢ **B.Com** - Commerce (3 years)
‚Ä¢ **BBA+MBA** - Integrated program (5 years)
‚Ä¢ **Economics** - B.A/B.Sc Economics

üíº **Career Paths:**
‚Ä¢ **Banking & Finance** - Investment banking, retail banking
‚Ä¢ **Corporate Sector** - Finance, accounting, taxation
‚Ä¢ **Consulting** - Management consulting, financial advisory
‚Ä¢ **Government** - RBI, SEBI, taxation departments
‚Ä¢ **Entrepreneurship** - Start your own business

üöÄ **Emerging Fields:**
‚Ä¢ **Fintech** - Digital payments, blockchain
‚Ä¢ **Data Analytics** - Business intelligence, data science
‚Ä¢ **Sustainability** - ESG consulting, green finance

Which area interests you most? I can provide more specific guidance!`
  },

  // Arts and Humanities
  arts: {
    keywords: ["arts", "humanities", "psychology", "law", "journalism", "literature", "history"],
    response: `Arts and Humanities offer incredibly diverse career paths! Here's your guide:

üé® **Popular Career Options:**

**Law:**
‚Ä¢ **LLB** - 3 years after graduation or 5 years integrated
‚Ä¢ **Career paths:** Corporate law, litigation, judiciary, legal consulting
‚Ä¢ **Average salary:** ‚Çπ3-15 LPA (varies significantly)

**Psychology:**
‚Ä¢ **B.A/B.Sc Psychology** - 3 years
‚Ä¢ **Career paths:** Clinical psychology, counseling, HR, research
‚Ä¢ **Average salary:** ‚Çπ3-8 LPA

**Journalism & Mass Communication:**
‚Ä¢ **BJMC** - 3 years
‚Ä¢ **Career paths:** News reporting, digital media, content creation, PR
‚Ä¢ **Average salary:** ‚Çπ2-8 LPA

**Public Administration:**
‚Ä¢ **B.A Public Administration** - 3 years
‚Ä¢ **Career paths:** Civil services, government administration, NGOs
‚Ä¢ **Average salary:** ‚Çπ3-12 LPA

**Sociology & Social Work:**
‚Ä¢ **B.A Sociology/Social Work** - 3 years
‚Ä¢ **Career paths:** Social work, community development, research
‚Ä¢ **Average salary:** ‚Çπ2-6 LPA

**Languages & Literature:**
‚Ä¢ **B.A in specific languages** - 3 years
‚Ä¢ **Career paths:** Translation, teaching, content writing, diplomacy
‚Ä¢ **Average salary:** ‚Çπ2-7 LPA

üéØ **Government Career Options:**
‚Ä¢ **Civil Services** - IAS, IPS, IFS
‚Ä¢ **Defense Services** - Army, Navy, Air Force
‚Ä¢ **Teaching** - Government schools, colleges
‚Ä¢ **Public Sector Banks** - Various positions

üí° **My Advice:**
1. **Passion matters** - Choose what genuinely interests you
2. **Skill development** - Focus on practical skills
3. **Networking** - Build connections in your field
4. **Higher education** - Consider postgraduate studies

Which field interests you most? I can provide more specific guidance!`
  },

  // Skill development
  skills: {
    keywords: ["skills", "skill development", "learn", "develop", "improve skills", "training"],
    response: `Developing the right skills is crucial for career success! Here's your skill development guide:

üõ†Ô∏è **Essential Skills for 2024:**

**Technical Skills (Hard Skills):**
‚Ä¢ **Digital Literacy** - Basic computer skills, online tools
‚Ä¢ **Data Analysis** - Excel, Google Analytics, basic statistics
‚Ä¢ **Programming** - Python, JavaScript, SQL (even basics help)
‚Ä¢ **Design** - Canva, Adobe Creative Suite, UI/UX basics
‚Ä¢ **Marketing** - Social media, content creation, SEO basics

**Soft Skills (Most Important):**
‚Ä¢ **Communication** - Verbal, written, presentation skills
‚Ä¢ **Problem Solving** - Analytical thinking, creativity
‚Ä¢ **Leadership** - Team management, decision making
‚Ä¢ **Adaptability** - Learning agility, resilience
‚Ä¢ **Emotional Intelligence** - Self-awareness, empathy

üéØ **Industry-Specific Skills:**

**For Tech Careers:**
‚Ä¢ Programming languages, cloud computing, cybersecurity
‚Ä¢ Agile methodology, version control (Git)

**For Business Careers:**
‚Ä¢ Financial modeling, project management, negotiation
‚Ä¢ CRM tools, business intelligence

**For Creative Careers:**
‚Ä¢ Design software, storytelling, brand development
‚Ä¢ Portfolio building, client management

**For Healthcare:**
‚Ä¢ Medical terminology, patient care, research skills
‚Ä¢ Healthcare technology, compliance knowledge

üí° **Skill Development Tips:**
1. **Start with basics** - Master fundamentals first
2. **Practice regularly** - Consistent practice is key
3. **Get feedback** - Learn from mentors and peers
4. **Build projects** - Apply skills in real scenarios
5. **Stay updated** - Industries evolve rapidly

üöÄ **Free Learning Resources:**
‚Ä¢ **Online Courses:** Coursera, edX, Khan Academy
‚Ä¢ **YouTube Channels:** Industry-specific tutorials
‚Ä¢ **Books:** Industry publications and guides
‚Ä¢ **Practice Platforms:** GitHub, Kaggle, Codecademy

Which skills are you most interested in developing? I can provide specific learning paths!`
  }
};

// Function to get career guidance response
function getCareerResponse(userMessage) {
  const message = userMessage.toLowerCase().trim();
  
  // Check each category for matching keywords
  for (const [category, data] of Object.entries(careerResponses)) {
    for (const keyword of data.keywords) {
      if (message.includes(keyword.toLowerCase())) {
        return data.response;
      }
    }
  }
  
  // Default response for general career guidance
  return `Hello! I'm Careerly AI, your career guidance assistant. I'm here to help you with:

üéØ **Career Planning** - Choose the right career path
üìö **Education Guidance** - Select the best courses and streams  
üíº **Skill Development** - Learn in-demand skills
üöÄ **Job Search Tips** - Find your dream job
üìà **Career Growth** - Advance in your chosen field

What would you like to know about? You can ask me about:
‚Ä¢ Career options after 10th/12th
‚Ä¢ Engineering, Medical, Commerce, Arts streams
‚Ä¢ Skill development and learning paths
‚Ä¢ Job opportunities and salary prospects
‚Ä¢ Career planning and goal setting

How can I help you today?`;
}

// GET endpoint for testing (shows form)
app.get("/api/chat", (req, res) => {
  res.send(`
    <html>
      <head><title>Careerly AI Chatbot Test</title></head>
      <body style="font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px;">
        <h1>ü§ñ Careerly AI Career Guidance Chatbot</h1>
        <p>Test the chatbot by asking career questions!</p>
        
        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <h3>Try these questions:</h3>
          <ul>
            <li><a href="javascript:askQuestion('What to choose after 10th?')">What to choose after 10th?</a></li>
            <li><a href="javascript:askQuestion('Engineering career options')">Engineering career options</a></li>
            <li><a href="javascript:askQuestion('Medical field careers')">Medical field careers</a></li>
            <li><a href="javascript:askQuestion('Commerce career paths')">Commerce career paths</a></li>
            <li><a href="javascript:askQuestion('Skills to develop')">Skills to develop</a></li>
          </ul>
        </div>

        <div style="background: #e8f4f8; padding: 20px; border-radius: 8px;">
          <h3>Or ask your own question:</h3>
          <input type="text" id="questionInput" placeholder="Ask about career guidance..." style="width: 70%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
          <button onclick="askQuestion(document.getElementById('questionInput').value)" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; margin-left: 10px; cursor: pointer;">Ask</button>
        </div>

        <div id="response" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; white-space: pre-wrap; display: none;"></div>

        <script>
          async function askQuestion(question) {
            if (!question.trim()) return;
            
            const responseDiv = document.getElementById('response');
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = 'ü§ñ Thinking...';
            
            try {
              const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: question })
              });
              
              const data = await response.json();
              responseDiv.innerHTML = 'ü§ñ ' + data.reply;
            } catch (error) {
              responseDiv.innerHTML = '‚ùå Error: ' + error.message;
            }
          }
        </script>
      </body>
    </html>
  `);
});

// Chat endpoint with career guidance
app.post("/api/chat", async (req, res) => {
  const userMessage = req.body.message;

  if (!userMessage || !userMessage.trim()) {
    return res.status(400).json({ 
      error: "Message is required",
      reply: "Please ask me a question about career guidance!"
    });
  }

  try {
    // First try to get career guidance response
    const careerResponse = getCareerResponse(userMessage);
    
    // If it's a general question, try Hugging Face API for more natural conversation
    let finalResponse = careerResponse;
    
    if (userMessage.toLowerCase().includes('hello') || 
        userMessage.toLowerCase().includes('hi') || 
        userMessage.toLowerCase().includes('hey') ||
        careerResponse.includes('Hello! I\'m Careerly AI')) {
      
      try {
        const response = await axios.post(
          "https://api-inference.huggingface.co/models/meta-llama/Llama-3-8B-Instruct",
          { inputs: userMessage },
          {
            headers: {
              Authorization: `Bearer ${process.env.HF_API_KEY}`,
              "Content-Type": "application/json",
            },
            timeout: 5000 // 5 second timeout
          }
        );

        const hfResponse = response.data[0]?.generated_text;
        if (hfResponse && hfResponse.length > 10) {
          // Combine career guidance with AI response for greetings
          finalResponse = `Hello! I'm Careerly AI, your career guidance assistant. ${hfResponse}\n\n${careerResponse}`;
        }
      } catch (hfError) {
        console.log("HF API not available, using career guidance response");
        // Use career guidance response as fallback
      }
    }

    res.json({ 
      reply: finalResponse,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    console.error("Error:", error.message);
    
    // Fallback career guidance response
    const fallbackResponse = `I'm here to help with career guidance! Here are some popular topics you can ask about:

üéØ **Career Options After 10th:**
‚Ä¢ Which stream to choose - Science, Commerce, or Arts?
‚Ä¢ Career paths in different streams
‚Ä¢ How to make the right decision

üöÄ **Engineering:**
‚Ä¢ Best engineering branches
‚Ä¢ Job opportunities and salary prospects
‚Ä¢ Higher studies after engineering

üè• **Medical:**
‚Ä¢ MBBS and other medical courses
‚Ä¢ NEET preparation and career paths
‚Ä¢ Alternative healthcare careers

üí∞ **Commerce & Business:**
‚Ä¢ CA, CS, CFA career options
‚Ä¢ MBA and business degrees
‚Ä¢ Finance and banking careers

üé® **Arts & Humanities:**
‚Ä¢ Law, psychology, journalism careers
‚Ä¢ Government job opportunities
‚Ä¢ Creative and social work careers

What would you like to know about?`;
    
    res.json({ 
      reply: fallbackResponse,
      timestamp: new Date().toISOString()
    });
  }
});

// Health check endpoint
app.get("/api/health", (req, res) => {
  res.json({ 
    status: "OK", 
    message: "Careerly AI Career Guidance Chatbot is running!",
    timestamp: new Date().toISOString()
  });
});

// Get suggested questions endpoint
app.get("/api/suggestions", (req, res) => {
  const suggestions = [
    "What career options are available after 10th grade?",
    "Which engineering branch has the best job opportunities?",
    "How to prepare for NEET exam?",
    "What are the career options in commerce?",
    "Which professional course should I choose - CA, CS, or CFA?",
    "What are government job options after arts?",
    "What skills should I develop for my career?",
    "How to choose between science, commerce, and arts?",
    "What are the emerging career fields?",
    "How to plan my career path?"
  ];
  
  res.json({ 
    suggestions,
    message: "Here are some popular career guidance questions you can ask!"
  });
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log(`üöÄ Careerly AI Career Guidance Chatbot running on port ${PORT}`);
  console.log(`üìä Environment: ${process.env.NODE_ENV || 'development'}`);
  console.log(`üîó Health Check: http://localhost:${PORT}/api/health`);
  console.log(`üí¨ Chat API: http://localhost:${PORT}/api/chat`);
  console.log(`üí° Suggestions: http://localhost:${PORT}/api/suggestions`);
});
